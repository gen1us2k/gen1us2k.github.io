<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Geocoder on Andrew Minkin</title>
    <link>http://gen1us2k.com/tags/geocoder/</link>
    <description>Recent content in Geocoder on Andrew Minkin</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <copyright>Gen1us2k</copyright>
    <lastBuildDate>Thu, 31 Mar 2016 19:45:23 +0600</lastBuildDate>
    <atom:link href="http://gen1us2k.com/tags/geocoder/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Ariadna. Зачем нужен еще один геокодер для ОСМ?</title>
      <link>http://gen1us2k.com/2016/03/31/ariadna/</link>
      <pubDate>Thu, 31 Mar 2016 19:45:23 +0600</pubDate>
      
      <guid>http://gen1us2k.com/2016/03/31/ariadna/</guid>
      <description>

&lt;p&gt;Всем привет!&lt;/p&gt;

&lt;p&gt;Совсем недавно я закончил делать геокодер для своих целей &lt;a href=&#34;https://github.com/gen1us2k/ariadna&#34;&gt;Ariadna&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;В статье не будет ни строчки кода на Go.  Зато будет полное описание работы геокодера и проблем, с которыми я встречался. А код можете посмотреть на гитхабе.&lt;/p&gt;

&lt;h3 id=&#34;предыстория:ef594d42b562dc51868faca891ac3a45&#34;&gt;Предыстория&lt;/h3&gt;

&lt;p&gt;Я работаю в одной из бишкекских служб такси, что в Кыргызстане. Решили мы пооптимизировать нахождение координат по адресу для более оптимального распределения заказов.&lt;/p&gt;

&lt;p&gt;Чего у нас нет:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Полной карты Яндекса, Гугла или 2Гис&lt;/li&gt;
&lt;li&gt;Доверия к GPS данным&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Что у нас есть:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Очень разношерстные данные на входе&lt;/li&gt;
&lt;li&gt;Openstreetmap&lt;/li&gt;
&lt;li&gt;Своя накопленная база адресов с координатами&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;что-пользователи-могут-вводить:ef594d42b562dc51868faca891ac3a45&#34;&gt;Что пользователи могут вводить?&lt;/h3&gt;

&lt;p&gt;Пользователи могут вводить адреса в разных форматах:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Улица дом&lt;/li&gt;
&lt;li&gt;Перекресток&lt;/li&gt;
&lt;li&gt;Название заведения&lt;/li&gt;
&lt;li&gt;Название точки&lt;/li&gt;
&lt;li&gt;микрорайон дом&lt;/li&gt;
&lt;li&gt;микрорайон улица дом&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;И таких вариантов  очень много, например
Киевская 28
Киевская Советская
5-42
5 микрорайон советская 42
ЦУМ
кафе у Ашота
шлагбаум
И так далее&lt;/p&gt;

&lt;h3 id=&#34;постановка-задачи:ef594d42b562dc51868faca891ac3a45&#34;&gt;Постановка задачи&lt;/h3&gt;

&lt;p&gt;Сделать геокодер, который бы умел принимать любые данные на вход и отдавать им координаты
Язык поиска - только русский.&lt;/p&gt;

&lt;h3 id=&#34;как-докатился-до-такой-жизни:ef594d42b562dc51868faca891ac3a45&#34;&gt;Как докатился до такой жизни&lt;/h3&gt;

&lt;p&gt;Перед тем, как делать свой велосипед я решил поресерчить решения, которые уже есть.
Были:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/pelias/pelias&#34;&gt;Pelias&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/twain47/Nominatim&#34;&gt;Nominatim&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://photon.komoot.de/&#34;&gt;Photon&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Чем не устраивал номинатим, который у нас был:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Сложен сам по себе&lt;/li&gt;
&lt;li&gt;Сделан на php+с(Это не потому что пхп плохой, а потому что только для этого инструмента у нас стоит апач и пхп)&lt;/li&gt;
&lt;li&gt;Сложная логика в хранимых процедурах Postgresql&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Чем понравился Pelias:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Может работать с многими источниками геоданных&lt;/li&gt;
&lt;li&gt;Поиск организован на ElasticSearch&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;В итоге решил отказаться от всех трех геокодеров и сделать свой инструмент по нескольким причинам:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Я хочу разобраться с данными в OSM и импортить только нужные для поиска&lt;/li&gt;
&lt;li&gt;Я могу обрабатывать геоданные перед занесением в индекс&lt;/li&gt;
&lt;li&gt;Мне не нравится жаваскрипт и node.js, отсюда и не желание делать поиск на основе пелиаса&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&#34;проектирование:ef594d42b562dc51868faca891ac3a45&#34;&gt;Проектирование&lt;/h3&gt;

&lt;p&gt;Был заложен следующий алгоритм:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Сначала получаем геометрию по крупным населенным пунктам(города, столицы, деревни, жилые массивы)&lt;/li&gt;
&lt;li&gt;Выгружаем все возможные адреса и соотносим их к нужному жилому массиву, городу и другому населенному пункту, выставляя нужное значение&lt;/li&gt;
&lt;li&gt;Выгружаем все дороги&lt;/li&gt;
&lt;li&gt;Ищем пересечение дорог&lt;/li&gt;
&lt;li&gt;Кладем все в индекс&lt;/li&gt;
&lt;li&gt;Ищем&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Для реализации я выбрал Go, учитывая проекты типа &lt;a href=&#34;https://github.com/pelias/pbf2json&#34;&gt;pbf2json&lt;/a&gt;, &lt;a href=&#34;github.com/kellydunn/golang-geo&#34;&gt;golang-geo&lt;/a&gt; и многих других для обработки геоданных. Также хотелось покачать скилл именно в нем.&lt;/p&gt;

&lt;h3 id=&#34;реализация:ef594d42b562dc51868faca891ac3a45&#34;&gt;Реализация&lt;/h3&gt;

&lt;p&gt;С получением и парсингом данных с осм вроде разобрался. Для жилых массивов используем теги place=city,place=village,place=suburb,place=town,place=neighbourhood для фильтрации. Для получения адресов, зданий addr:street+addr:housenumber,amenity,shop,addr:housenumber
Все дороги можно получить с помощью тега highway&lt;/p&gt;

&lt;p&gt;Встали сложности с поиском англоязычных названий на русском языке. Как пробовал это решить:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Простая автоматическая транслитерация в русский. В итоге получалось абсурдной и не корректной. Пример конвертации данных был таким: City House -&amp;gt; Цити Хоусе&lt;/li&gt;
&lt;li&gt;Давай попробуем преобразовывать так. Получать транскрипцию слова и ее уже транслитерировать. Получилось что-то вроде Adrenaline rush -&amp;gt; Эрденалин Рэш. Сносно, но нужен русский акцент, типа адреналин раш.&lt;/li&gt;
&lt;li&gt;Подошел такой механизм. Автоматически транслитеризуем все данные, применяя словарь замен. Все-таки простая и тупая транслитерация работает сносно. Словарь наполнился в принципе быстро через несколько прогонов на данных.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;С этим разобрались к этому моменту мы уже получаем данные, которые:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Нормализированы и приведены к русскому языку&lt;/li&gt;
&lt;li&gt;адреса приведены к формату Страна, город, село или поселок, микрорайон или жилой массив, улица, дом&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Следующая часть квеста - найти пересечения дорог. Сделал ее по быстрому и получил очень медленную реализацию, сложностью O(n^2). Как временный выход использую Postgres+postgis для нахождения пересечений, пока не нашел хорошего алгоритма для поиска пересечений.&lt;/p&gt;

&lt;p&gt;В итоге получился хороший парсер данных с осм, который кладет данные в ElasticSearch. Который получил простое название importer&lt;/p&gt;

&lt;h3 id=&#34;автоматизируй-это:ef594d42b562dc51868faca891ac3a45&#34;&gt;Автоматизируй это&lt;/h3&gt;

&lt;p&gt;Учитывая то, что постоянно выкачивать и создавать индексы в эластиксерче в скоре надоело, появился компонент updater. Появилась также автоматическая конфигурация в JSON формате.&lt;/p&gt;

&lt;p&gt;Процесс выкачивания файла и импорт его в elastic search автоматизировался. Плюс к этому появилась возможность обновлять данные в эластиксерче без даунтайма, благодаря алиасам.&lt;/p&gt;

&lt;p&gt;Как это работает:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Updater качает файл&lt;/li&gt;
&lt;li&gt;Узнает текущую версию индекса с конфига&lt;/li&gt;
&lt;li&gt;Инкрементит версию и создает новый индекс&lt;/li&gt;
&lt;li&gt;Заполняет его данными&lt;/li&gt;
&lt;li&gt;Меняет алиасы&lt;/li&gt;
&lt;li&gt;Удаляет старый индекс&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Получил такие бенефиты от этого:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Пишем конфиг&lt;/li&gt;
&lt;li&gt;Запускаем ./ariadna update&lt;/li&gt;
&lt;li&gt;Идем пить кофе&lt;/li&gt;
&lt;li&gt;Получаем готовый настроенный индекс.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Также для удобства прикрутил простой вебинтерфейс с картой и возможностью поиска.&lt;/p&gt;

&lt;h3 id=&#34;автоматическое-пополнение-данными:ef594d42b562dc51868faca891ac3a45&#34;&gt;Автоматическое пополнение данными&lt;/h3&gt;

&lt;p&gt;Помимо ОСМ у нас еще есть много водителей и операторы, которые забивают заказы.
Соотвественно у нас есть имя и координаты
Сделана такая схема:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Треки водителей хранятся в индексе drivers_data&lt;/li&gt;
&lt;li&gt;Данные с ОСМ хранятся в индексе osm_data&lt;/li&gt;
&lt;li&gt;Объединены они через алиас addresses по которому и происходит поиск адресов&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Данные от водителей заносятся, если у нас погрешность в определенных координатах больше, чем 200 метров.&lt;/p&gt;

&lt;h3 id=&#34;итого:ef594d42b562dc51868faca891ac3a45&#34;&gt;Итого&lt;/h3&gt;

&lt;p&gt;Получился геокодер который умеет:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Искать координаты по синонимам. например ШВК - ШампанВинКомбинат&lt;/li&gt;
&lt;li&gt;Умеет искать адреса в определенном радиусе (например для себя с сделал поиск адресов в 30 км от центра города)&lt;/li&gt;
&lt;li&gt;Искать по названию заведений (кафе у Ашота например)&lt;/li&gt;
&lt;li&gt;Искать перекрестки&lt;/li&gt;
&lt;li&gt;Искать адреса в микрорайонах и жил массивах&lt;/li&gt;
&lt;li&gt;Делать реверс геокодинг&lt;/li&gt;
&lt;li&gt;Автоматически пополнятся новыми данными от водителей&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Состоит из трех компонентов:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Импортер данных&lt;/li&gt;
&lt;li&gt;Апдейтер данных&lt;/li&gt;
&lt;li&gt;Веб интерфейс&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&#34;минусы:ef594d42b562dc51868faca891ac3a45&#34;&gt;Минусы&lt;/h3&gt;

&lt;ol&gt;
&lt;li&gt;Протестирован только для Кыргызстана&lt;/li&gt;
&lt;li&gt;Нет демки&lt;/li&gt;
&lt;li&gt;Нет поддержки всех схем адресации&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Поэтому надеюсь кто-нибудь поможет его допилить и для хорошего поиска по другим странам и городам.&lt;/p&gt;

&lt;p&gt;Если кому-то проект показался интересным, то я не против  любой критики, пул реквестов, issues на гитхабе и фидбека в целом.&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>